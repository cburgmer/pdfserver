{% extends "base.html" %}
{% block content %}
<script type="text/javascript">
//<![CDATA[
    var pdfgenerated_check_interval = -1;
    Array.max = function( array ){
        return Math.max.apply(Math , array);
    };
    Array.min = function( array ){
        return Math.min.apply(Math , array);
    };
    $.validator.addMethod(
        "pageranges",
        function(value, element) {
            // accept combinations of "1-10", "-10", "1-" separated by "," or ";" or "/" but no single "0"
            return this.optional(element) || /^\s*(\d+\s*-\s*\d*|\d*\s*-\s*\d+|\d+)(\s*[;,\/]\s*(\d+\s*-\s*\d*|\d*\s*-\s*\d+|\d+))*\s*$/.test(value) && 0 < Array.min(value.match(/\d+/g));
        },
        "{{ _("Please check your input.") }}"
    );
    $.validator.addMethod(
        "maxpages",
        function(value, element, param) {
            // make sure all numbers mentioned are smaller or equal to parameter
            return this.optional(element) || Array.max(value.match(/\d+/g)) <= param;
        },
        "{{ _("There are only maximum {0} pages.") }}"
    );
    $(function() {
        function cycle_mark_uploads() {
            $.each($("#files tr"), function(idx, item) {
                console.log(idx, item);
                if (idx % 2) {
                    $(item).attr('class', 'odd');
                } else {
                    $(item).attr('class', 'even');
                }
            });
        }
        cycle_mark_uploads();
        $("#files").sortable({
            stop: function(event, ui) { cycle_mark_uploads() },
        });
        $(".noselection").disableSelection();
        $("#deleteall").dialog({
            autoOpen: false,
            resizable: false,
            modal: true,
            buttons: {
                '{{ _("Delete all files") }}': function() {
                    document.forms['deleteall'].submit();
                    $(this).dialog('close');
                },
                '{{ _("Cancel") }}': function() {
                    $(this).dialog('close');
                }
            }
        });
        $("#pdfgenerated").dialog({
            autoOpen: false,
            resizable: false,
            modal: true,
            buttons: {
                '{{ _("Cancel") }}': function() {
                    // Cancel checking
                    pdfgenerated_check_interval = -1;
                    $(this).dialog('close');
                }
            },
            // Add handler to remove download once closed (privacy)
            close:  function(event, ui) {
                if ($('#pdfgenerated_link').attr('title')) {
                    $.ajax({
                        type : 'POST',
                        dataType : 'json',
                        url : '{{ url_for('remove_download') }}',
                        data: 'task_id=' + $('#pdfgenerated_link').attr('title')
                    });
                }
            }
        });
        // nice input buttons
        $(".deletebutton").button({
            icons: {
                primary: 'ui-icon-circle-close',
            },
            label: "{{ _("Delete") }}",
            text: false,
        });
        $(".deleteallbutton").button({
            icons: {
                primary: 'ui-icon-circle-close',
            },
            label: "{{ _("All") }}",
            text: true,
        });
        $("#combinebutton").button({
            icons: {
                primary: 'ui-icon-document'
            },
            text: true
        });
        $("#moreoptionsbutton").button({
            icons: {
                primary: 'ui-icon-circlesmall-plus'
            },
            label: "{{ _("More options") }}",
            text: true
        });
        $("#lessoptionsbutton").button({
            icons: {
                primary: 'ui-icon-circlesmall-minus'
            },
            label: "{{ _("Less options") }}",
            text: true
        });
        $("#uploadbutton").button({
            icons: {
                primary: 'ui-icon-plusthick'
            },
            text: true
        });
        $("#filesform").validate();
        $('#filesform').submit(function() {
            function test_pdf_finished(check_url) {
                if (pdfgenerated_check_interval <= 0) {
                    return
                }
                setTimeout(
                    function(){
                        $.ajax({
                            type : 'GET',
                            dataType : 'json',
                            url : check_url,
                            error: function(req, st, err) {
                                $("#pdfgenerated_msg").html('{{ _("An error occurred: ") }}' + st);
                            },
                            success: function(data) {
                                    if (data.ready && data.success) {
                                        $("#pdfgenerated_msg").html('{{ _("Your PDF file has been generated.") }} <p><a id="pdfgenerated_link" target="_blank" href="' + data.url + '" title="' + data.task_id + '">{{ _("Download PDF...") }}</a></p>');
                                        //window.open(data.url, 'generatedpdf');
                                        $("#pdfgenerated").dialog("option", "buttons", {
                                            "Finish": function() { $(this).dialog("close"); }
                                        });
                                    } else if (data.ready && !data.success) {
                                        $("#pdfgenerated_msg").html('{{ _("Error generating the PDF.") }}');
                                    } else {
                                        test_pdf_finished(check_url);
                                    }
                            }
                        });
                        pdfgenerated_check_interval *= 1.5;
                    },
                    pdfgenerated_check_interval);
            };
            $('#pdfgenerated').dialog('open');
            $("#pdfgenerated_msg").html('{{ _("Generating your PDF...") }}<br/><img src="{{ url_for('static', filename='ajax-loader.gif')}}" alt="loading" />');
            pdfgenerated_check_interval = 500;
            $.ajax({
                type : 'POST',
                dataType : 'json',
                url : '{{ url_for('combine_pdfs') }}',
                data: $('#filesform').serialize() + '&' + $('#files').sortable('serialize'),
                error: function(req, st, err) {
                    ("#pdfgenerated_msg").html('{{ _("An error occurred: ") }}' + st);
                },
                success: function(data, textStatus, request) {
                    test_pdf_finished(data.url);
                }
            });
            return false;
        });
    });
//]]>
</script>
<h1>{{ _("Welcome to pdfserver") }}</h1>
<p>{{ _("Upload PDF files, drag them into the right order and recombine pages.") }}</p>

<h3>{{ _("PDF files") }}</h3>
<form action="{{ url_for('combine_pdfs') }}" id="filesform" name="combine" method="post">
<table id="filetable">
    <thead>
    <tr>
        <th style="width: 20px;"></th>
        <th>{{ _("Name") }}</th>
        <th style="width: 80px;">{{ _("Size") }}</th>
        <th style="width: 40px;">{{ _("Pages") }}</th>
        <th style="width: 180px;"><span style="font-style:italic;">{{ _("Optionally select pages (e.g. '1-4, 6, 19-')") }}</span></th>
        <th style="width: 40px;"></th>
    </tr>
    </thead>
    <tfoot>
        <tr id="moreoptions">
            <td colspan="6">
                <span>
                    {{ _("Pages per sheet") }}<br/>
                    <span style="display: inline-block;">
                    <input type="radio" name="pages_sheet" value="1" checked="checked" /> 1<br/>
                    <input type="radio" name="pages_sheet" value="2"/> 2<br/>
                    <input type="radio" name="pages_sheet" value="4"/> 4
                    </span>
                    <span style="display: inline-block;">
                    <input type="radio" name="pages_sheet" value="6"/> 6<br/>
                    <input type="radio" name="pages_sheet" value="9"/> 9<br/>
                    <input type="radio" name="pages_sheet" value="16"/> 16
                    </span>
                </span>
                <span>
                    {{ _("Rotate clockwise by") }}<br/>
                    <input type="radio" name="rotate" value="0" checked="checked" /> 0째<br/>
                    <input type="radio" name="rotate" value="90"/> 90째<br/>
                    <input type="radio" name="rotate" value="180"/> 180째<br/>
                    <input type="radio" name="rotate" value="270"/> 270째
                </span>
                <span>
                    {{ _("Insert watermark (e.g. 'DRAFT')") }}<br/>
                    <input type="text" name="text_overlay"/>
                </span>
            </td>
        </tr>
        <tr>
            <td colspan="2"><span style="font-size: 1.1em;">
            <a href="#" id="moreoptionsbutton" onclick="$('#moreoptions').fadeIn();$('#moreoptionsbutton').hide();$('#lessoptionsbutton').show();"></a>
            <a href="#" style="display: none;" id="lessoptionsbutton" onclick="$('#moreoptions').fadeOut();$('#lessoptionsbutton').hide();$('#moreoptionsbutton').show();"></a>
            </span></td>
            <td colspan="3" style="text-align: right;"><span style="font-size: 1.1em;">
            <button type="submit" id="combinebutton"{% if uploads %}{% else %} onclick="return false"{% endif %}>{{ _("Combine &amp; open") }}</button>
            </span></td>
            <td><span style="font-size: 1.1em;"><a href="#" id="deleteallanchor" class="deleteallbutton"{% if uploads %} onclick="$('#deleteall').dialog('open'); return false"{% else %} onclick="return false"{% endif %}></a></span></td>
        </tr>
    </tfoot>
    {% if uploads %}
    <tbody id="files">
    {% for upload in uploads %}
        <tr class="{{ loop.cycle('even', 'odd') }}" id="file_{{ loop.index }}">
            <td><span class="noselection ui-icon ui-icon-arrowthick-2-n-s"></span></td>
            <td><span class="noselection text">{{upload.filename}}</span></td>
            <td><span class="noselection text">{% if upload.size %}{{upload.size|filesizeformat}}{% endif %}</span></td>
            <td style="text-align: right;"><span class="noselection text">{{upload.page_count}}</span></td>
            <td><input type="text" class="pageranges" name="pages_{{ loop.index }}" id="pages_{{ loop.index }}"/>
            <script type="text/javascript">$(function() {$("#pages_{{ loop.index }}").rules("add", {maxpages: {{upload.page_count}} })});</script>
            </td>
            <td style="text-align: right;"><a class="deletebutton" id="deleteanchor_{{ loop.index }}" href="#" onclick="document.forms['deletefile_{{ loop.index }}'].submit(); return false"></a></td>
        </tr>
    {% endfor %}
    </tbody>
    {% else %}
    <tbody>
        <tr>
            <td colspan="6"><span style="font-style:italic;">{{ _("There are no uploaded files at present.") }}</span></td>
        </tr>
    </tbody>
    {% endif %}
</table>
<script type="text/javascript">$('#moreoptions').hide();</script>
</form>
<div id="upload">
    <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" accept-charset="utf-8">
        <h3>{{ _("Upload a new file") }}</h3>
        <input type="file" name="file" id="id_file" />
        <button type="submit" id="uploadbutton">{{ _("Upload") }}</button>
    </form>
</div>
{% if uploads %}
<!-- HTML wouldn't allow us to place a form inside a form, so put basis here and call by Javascript -->
{% for upload in uploads %}
    <form action="{{ url_for('delete') }}" method="post" name="deletefile_{{ loop.index }}">
        <input type="hidden" name="id" value="{{upload.id}}"/>
        <input type="hidden" name="delete" value="Delete"/>
    </form>
{% endfor %}
{% endif %}

<noscript>
<!-- Allow at least deletion of all files if Javascript isn't around -->
<div>
    <h3>{{ _("Delete") }}</h3>
    <form action="{{ url_for('confirm_delete_all') }}" method="post">
        <input type="submit" value="{{ _("Delete all files") }}"/>
    </form>
</div>
</noscript>
<div id="deleteall" style="display: none;" title="{{ _("Confirm deletion") }}">
        <p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>{{ _("All files will be deleted. Are you sure?") }}</p>
        <form action="{{ url_for('delete_all') }}" name="deleteall" method="post">
        <input type="hidden" name="delete" value="Delete all"/>
        </form>
</div>
<div id="pdfgenerated" style="display: none;" title="{{ _("Generating PDF") }}">
    <p>
        <span class="ui-icon ui-icon-clock" style="float:left; margin:0 7px 50px 0;"></span>
        <span id="pdfgenerated_msg"></span>
    </p>
</div>

<div style="margin-top: 30px;">
<h3>{{ _("Hints") }}</h3>
<ul>
<li>{{ _("To simply join documents you can leave the page selection empty.") }}</li>
<li>{{ _("If you want to insert pages from a document B into the middle of document A, upload A twice selecting first the initial and then the final range separately.") }}</li>
<li>{{ _("Storing several pages on one sheet will only work on a per-document basis. If you need to merge pages between documents combine the documents first and then in a second run actually merge pages onto one sheet.") }}</li>
</ul>
</div>

<div style="width: 100%" class="footer">{% trans %}<a href="http://pdfserverapp.appspot.com/">Pdfserver</a> is <a href="http://github.com/cburgmer/pdfserver/blob/master/LICENSE">free and open source software</a> and is available from <a href="http://github.com/cburgmer/pdfserver">Github</a>.{% endtrans %}
<div style="float: right;"><a href="http://validator.w3.org/check?uri=referer"><img style="border: 0 none;" src="http://www.w3.org/Icons/valid-xhtml10" alt="Valid XHTML 1.0 Transitional" height="31" width="88"/></a></div>
</div>
{% endblock %}
